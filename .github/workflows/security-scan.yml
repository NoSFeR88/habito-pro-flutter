# Security Scanning (SAST) - Plan Maestro Fase 2
# Static Application Security Testing + Secrets Detection

name: Security Scan

on:
  pull_request:
    branches:
      - master
      - main
  push:
    branches:
      - 'claude/**'
      - master
      - main
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Job 1: Secrets Detection with Gitleaks
  secrets-detection:
    name: ðŸ” Secrets Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: ðŸ” Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ðŸ“Š Upload Gitleaks Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif

  # Job 2: Dependency Scanning
  dependency-scan:
    name: ðŸ“¦ Dependency Security
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ” Check for known vulnerabilities
        run: |
          echo "Checking pubspec.lock for known vulnerabilities..."
          flutter pub outdated --show-all --json > outdated.json || true

      - name: ðŸ“Š Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: outdated.json

  # Job 3: Code Quality & Security Issues
  code-quality:
    name: ðŸ›¡ï¸ Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ” Run Flutter Analyze
        run: flutter analyze --no-fatal-infos --no-fatal-warnings > analyze-report.txt || true

      - name: ðŸ“Š Parse analyze results
        run: |
          echo "Parsing analyze results for security issues..."
          grep -i "error\|warning\|hint" analyze-report.txt > security-issues.txt || echo "No issues found"

      - name: ðŸ“¤ Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report
          path: |
            analyze-report.txt
            security-issues.txt

  # Job 4: OWASP Dependency Check (if applicable)
  owasp-check:
    name: ðŸ”’ OWASP Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'RITMO-Habit-Tracker'
          path: '.'
          format: 'HTML'
          args: >
            --enableRetired
            --enableExperimental

      - name: ðŸ“Š Upload OWASP report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports

  # Job 5: Security Summary
  security-summary:
    name: ðŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [secrets-detection, dependency-scan, code-quality]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4

      - name: ðŸ“Š Generate Security Summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f gitleaks-report/results.sarif ]; then
            echo "- ðŸ”´ **Secrets Detected**: Check Gitleaks report" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **No Secrets Detected**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f dependency-report/outdated.json ]; then
            echo "- âš ï¸ **Dependencies**: Check dependency report" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **Dependencies Up-to-date**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f code-quality-report/security-issues.txt ]; then
            ISSUES=$(wc -l < code-quality-report/security-issues.txt || echo "0")
            if [ "$ISSUES" -gt "0" ]; then
              echo "- âš ï¸ **Code Quality Issues**: $ISSUES found" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… **No Code Quality Issues**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recommendation**: Review all reports before merging." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
