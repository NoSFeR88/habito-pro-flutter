# GitHub Actions CI/CD para ramas claude/*
# Parte del Plan Maestro Claude Code + Agents

name: Claude Agent CI

on:
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
  push:
    branches:
      - 'claude/**'

jobs:
  # Job 1: AnÃ¡lisis y ValidaciÃ³n
  analyze:
    name: ğŸ“Š AnÃ¡lisis EstÃ¡tico
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get

      - name: ğŸ” Flutter Analyze
        run: flutter analyze
        continue-on-error: false

      - name: ğŸ“ Verificar formato
        run: dart format --set-exit-if-changed lib/ test/
        continue-on-error: true

  # Job 2: Tests
  test:
    name: ğŸ§ª Tests Unitarios
    runs-on: windows-latest
    timeout-minutes: 15
    needs: analyze

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get

      - name: ğŸ§ª Ejecutar tests
        run: flutter test --coverage

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-ritmo
        continue-on-error: true

  # Job 3: VerificaciÃ³n i18n
  i18n-check:
    name: ğŸŒ VerificaciÃ³n i18n
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get

      - name: ğŸŒ Generar traducciones
        run: flutter gen-l10n

      - name: ğŸ” Verificar strings hardcoded
        shell: pwsh
        run: |
          $hardcoded = Select-String -Path "lib\**\*.dart" -Pattern 'Text\(' -Recurse | Where-Object { $_ -notmatch 'AppLocalizations' }
          $count = ($hardcoded | Measure-Object).Count

          Write-Host "Strings hardcoded encontrados: $count"

          if ($count -gt 150) {
            Write-Host "âš ï¸  ADVERTENCIA: Demasiados strings hardcoded ($count > 150)" -ForegroundColor Yellow
            Write-Host "Se recomienda internacionalizar mÃ¡s strings" -ForegroundColor Yellow
          }
        continue-on-error: true

  # Job 4: Build Validation
  build-check:
    name: ğŸ—ï¸ ValidaciÃ³n de Build
    runs-on: windows-latest
    timeout-minutes: 20
    needs: [analyze, test]

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get

      - name: ğŸ—ï¸ Build APK Debug
        run: flutter build apk --debug
        continue-on-error: false

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # Job 5: Security Check
  security:
    name: ğŸ” Security Scan
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Verificar secrets en cÃ³digo
        shell: pwsh
        run: |
          Write-Host "ğŸ” Buscando posibles secrets expuestos..."

          # Patrones peligrosos
          $patterns = @(
            'AIzaSy[A-Za-z0-9_-]{33}',  # Google API Key
            'sk-[A-Za-z0-9]{48}',        # OpenAI API Key
            'password\s*=\s*[''"][^''"]+[''"]',
            'api[_-]?key\s*=\s*[''"][^''"]+[''"]'
          )

          $found = $false
          foreach ($pattern in $patterns) {
            $matches = Select-String -Path "lib\**\*.dart" -Pattern $pattern -Recurse 2>$null
            if ($matches) {
              Write-Host "âš ï¸  Posible secret encontrado con patrÃ³n: $pattern" -ForegroundColor Yellow
              $found = $true
            }
          }

          if (-not $found) {
            Write-Host "âœ… No se encontraron secrets expuestos" -ForegroundColor Green
          }
        continue-on-error: true

      - name: ğŸ” Verificar firebase_options.dart no modificado
        shell: pwsh
        run: |
          # Fetch master branch para comparaciÃ³n correcta
          git fetch origin master:master 2>$null

          # Comparar solo archivos modificados en este PR
          $changed = git diff --name-only origin/master...HEAD | Select-String 'firebase_options.dart'

          if ($changed) {
            Write-Host "âš ï¸  ADVERTENCIA: firebase_options.dart fue modificado en este PR" -ForegroundColor Red
            Write-Host "Este archivo contiene configuraciÃ³n sensible" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "âœ… firebase_options.dart no modificado en este PR" -ForegroundColor Green
          }
        continue-on-error: false

  # Job 6: PR Comment con Resultados
  comment-results:
    name: ğŸ’¬ Comentar Resultados en PR
    runs-on: windows-latest
    needs: [analyze, test, i18n-check, build-check, security]
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ’¬ Crear comentario de resultado
        uses: actions/github-script@v6
        with:
          script: |
            const body = `## ğŸ¤– Claude Agent CI - Resultados

            ### âœ… Checks Completados

            - âœ… **AnÃ¡lisis EstÃ¡tico**: Passed
            - âœ… **Tests Unitarios**: Passed
            - âœ… **VerificaciÃ³n i18n**: Passed
            - âœ… **Build Validation**: Passed
            - âœ… **Security Scan**: Passed

            ### ğŸ“Š Siguiente Paso

            Este PR estÃ¡ listo para revisiÃ³n humana. Por favor revisar:
            - [ ] Cambios en cÃ³digo
            - [ ] Tests agregados/actualizados
            - [ ] Traducciones completas (si aplica)
            - [ ] Sin regresiones visuales

            ---
            ğŸ¤– Generado automÃ¡ticamente por Claude Agent CI
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Job 7: Gate de AprobaciÃ³n (solo para PRs de claude/*)
  require-approval:
    name: ğŸš§ Requiere AprobaciÃ³n Humana
    runs-on: windows-latest
    needs: [analyze, test, i18n-check, build-check, security]
    if: startsWith(github.head_ref, 'claude/')

    steps:
      - name: ğŸš§ Bloquear merge automÃ¡tico
        run: |
          Write-Host "ğŸš§ Este PR de agente requiere aprobaciÃ³n humana manual" -ForegroundColor Yellow
          Write-Host "No se permite merge automÃ¡tico para ramas claude/*" -ForegroundColor Yellow
          Write-Host "Revisor: Por favor verificar cambios antes de aprobar" -ForegroundColor Cyan
        shell: pwsh

      - name: ğŸ“‹ Verificar que no sea WIP
        run: |
          $prTitle = "${{ github.event.pull_request.title }}"

          if ($prTitle -match 'WIP|DRAFT|DO NOT MERGE') {
            Write-Host "âŒ PR marcado como WIP/DRAFT - No listo para merge" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        continue-on-error: false
